# 倒三角相关性热图+层次聚类树

#### 1. 数据

- 这里有2个输入文件，data.csv 文件是变量的观测值数据，group.csv 文件是变量的分组数据。

#### 2. 计算相关性和层次聚类

- 绘制热图的数据一般都需要进行`log`转换，这样可以使得数据更加符合正态分布或者均匀分布，从而更容易观察到数据的差异。

- 由于聚类算法通常使用距离而不是相关系数，所以这里通过`1 - corr`将相关系数转换为距离，然后用`as.dist()`函数将其转换为距离矩阵。

- 使用`hclust()`函数对距离矩阵进行层次聚类分析。

- 最后按照聚类得到的变量顺序，对相关系数的数据框重新进行排序，这样变量在热图和聚类树中的顺序就一致了。

#### 3. 绘图-聚类树

- 使用`factoextra::fviz_dend()`函数来展示聚类树，这个包可以连接`theme()`函数来修改树图的外观。

#### 4. 绘图-三角热图

- 使用`geom_tile()`函数画热图
- 使用`scale_fill_gradient2()`函数设置渐变色，`break`参数可以指定颜色的显示范围。
- 使用`scale_y_discrete(position = "right")`函数将 Y 轴设置在右侧，这样才能得到原图的三角形效果。corrplot包的三角热图，标签不能移动，这是本次复现没使用 corrplot 的一个原因。
- `coord_fixed() `函数用于调整绘图的坐标系，使得绘制的图形在横向和纵向上具有相同的比例，也就是等边。

#### 5. 绘图-分组圆圈标记

- 这里需要注意将坐标轴往外延伸`expand_limits(x = c(0, 43), y = c(-1, 42.5))`，要不然圆圈图层会显示不全或者只能调小显示。

#### 6. 绘图-热图注释

- `geom_path()`函数可以绘制路径，通过给定一系列的点的坐标，在热图中添加三角形的聚类注释框，这个示例中添加了2个。corrplot 包只能给正方形的热图添加矩形框，不能给三角形热图添加，这是不使用 corrplot 的另一个原因。
- `geom_polygon()`函数可以画填充的多边形，也是通过指定一系列的点的坐标来实现，但是多边形的内部会被填充上颜色。

#### 7. 绘图-三角热图旋转45°

#### 8. 组合图形

- 这里使用`grid::viewport()`函数嵌套图形，注意 x,y 参数不是坐标而是对应的 X 轴和 Y 轴的比例位置。

### 最重要的是：

码代码不易，如果你觉得我的教程对你有帮助，请关注：

个人小红书 **Ms.Tt (号Ttian6688)**

个人公众号 **MsTt笔记**
